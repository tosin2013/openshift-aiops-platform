---
# Test NotebookValidationJob with PVC Volume Support
# Purpose: Validate that Jupyter Notebook Validator Operator v1.0.4-ocp4.20 supports PVC mounts
# Usage: oc apply -f tests/test-volume-support.yaml
# Validation: oc get notebookvalidationjob test-volume-support-v1.0.4 -n self-healing-platform -w

apiVersion: mlops.mlops.dev/v1alpha1
kind: NotebookValidationJob
metadata:
  name: test-volume-support-v1.0.4
  namespace: self-healing-platform
  labels:
    test: volume-support
    operator-version: v1.0.4-ocp4.20
  annotations:
    description: "Test PVC volume support in operator v1.0.4-ocp4.20"
spec:
  # Notebook to validate
  notebookPath: notebooks/00-setup/environment-setup.ipynb

  # Git repository configuration
  gitUrl: https://gitea-with-admin-gitea.apps.cluster-fn2qb.fn2qb.sandbox1343.opentlc.com/opentlc-mgr/openshift-aiops-platform.git
  gitRef: main

  # Timeout for validation
  timeout: 10m

  # Pod configuration with volume support
  podConfig:
    # Service account (required when webhooks disabled)
    serviceAccountName: default

    # Container image
    image: image-registry.openshift-image-registry.svc:5000/redhat-ods-applications/s2i-generic-data-science-notebook:2025.1

    # Resource requests and limits
    resources:
      requests:
        memory: "512Mi"
        cpu: "500m"
      limits:
        memory: "1Gi"
        cpu: "1000m"

    # Volume definitions (NEW in v1.0.4-ocp4.20)
    volumes:
      - name: model-storage
        persistentVolumeClaim:
          claimName: model-storage-pvc

    # Volume mounts (NEW in v1.0.4-ocp4.20)
    volumeMounts:
      - name: model-storage
        mountPath: /mnt/models

    # Environment variables for testing
    env:
      - name: TEST_VOLUME_SUPPORT
        value: "true"
      - name: MODEL_STORAGE_PATH
        value: "/mnt/models"
      - name: NOTEBOOK_TEST_MODE
        value: "volume-validation"
---
# Test NotebookValidationJob with Multiple Volumes
# Purpose: Test multiple PVC mounts in a single validation job
apiVersion: mlops.mlops.dev/v1alpha1
kind: NotebookValidationJob
metadata:
  name: test-multi-volume-support
  namespace: self-healing-platform
  labels:
    test: multi-volume-support
    operator-version: v1.0.4-ocp4.20
  annotations:
    description: "Test multiple PVC volume mounts in operator v1.0.4-ocp4.20"
spec:
  notebookPath: notebooks/00-setup/environment-setup.ipynb
  gitUrl: https://gitea-with-admin-gitea.apps.cluster-fn2qb.fn2qb.sandbox1343.opentlc.com/opentlc-mgr/openshift-aiops-platform.git
  gitRef: main
  timeout: 10m

  podConfig:
    serviceAccountName: default
    image: image-registry.openshift-image-registry.svc:5000/redhat-ods-applications/s2i-generic-data-science-notebook:2025.1

    resources:
      requests:
        memory: "512Mi"
        cpu: "500m"
      limits:
        memory: "1Gi"
        cpu: "1000m"

    # Multiple volume mounts
    volumes:
      - name: model-storage
        persistentVolumeClaim:
          claimName: model-storage-pvc
      - name: data-storage
        persistentVolumeClaim:
          claimName: data-pvc

    volumeMounts:
      - name: model-storage
        mountPath: /mnt/models
      - name: data-storage
        mountPath: /mnt/data

    env:
      - name: TEST_MULTI_VOLUME
        value: "true"
      - name: MODEL_STORAGE_PATH
        value: "/mnt/models"
      - name: DATA_STORAGE_PATH
        value: "/mnt/data"
---
# Validation Commands (for manual testing)
#
# 1. Apply test jobs:
#    oc apply -f tests/test-volume-support.yaml
#
# 2. Watch job status:
#    oc get notebookvalidationjob -n self-healing-platform -w
#
# 3. Check pod status:
#    oc get pods -n self-healing-platform -l test=volume-support
#
# 4. Verify volume mounts:
#    POD_NAME=$(oc get pods -n self-healing-platform -l test=volume-support -o jsonpath='{.items[0].metadata.name}')
#    oc exec -n self-healing-platform ${POD_NAME} -- ls -la /mnt/models
#    oc exec -n self-healing-platform ${POD_NAME} -- df -h /mnt/models
#
# 5. Check job logs:
#    oc logs -n self-healing-platform ${POD_NAME} --tail=100
#
# 6. Verify PVC access:
#    oc exec -n self-healing-platform ${POD_NAME} -- touch /mnt/models/test-file.txt
#    oc exec -n self-healing-platform ${POD_NAME} -- ls -la /mnt/models/test-file.txt
#
# 7. Check job status:
#    oc get notebookvalidationjob test-volume-support-v1.0.4 -n self-healing-platform -o yaml
#
# 8. Clean up:
#    oc delete notebookvalidationjob test-volume-support-v1.0.4 -n self-healing-platform
#    oc delete notebookvalidationjob test-multi-volume-support -n self-healing-platform
