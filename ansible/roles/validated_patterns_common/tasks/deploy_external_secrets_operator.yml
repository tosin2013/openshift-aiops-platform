---
# Task: Deploy External Secrets Operator
# Purpose: Ensure External Secrets Operator is deployed for credential management
# Part of: validated_patterns_common role
# Reference: ADR-026 - Secrets Management Automation
# Supports: Both OLM (external-secrets-operator namespace) and Helm (external-secrets-system namespace)

- name: Check if External Secrets Operator is already installed via OLM (method 1)
  kubernetes.core.k8s_info:
    kind: Subscription
    namespace: openshift-operators
    name: external-secrets-operator
  register: eso_subscription_openshift_operators
  ignore_errors: true

- name: Check if External Secrets Operator is already installed via OLM (method 2)
  kubernetes.core.k8s_info:
    kind: Subscription
    namespace: external-secrets-operator
    name: external-secrets-operator
  register: eso_subscription_dedicated
  ignore_errors: true

- name: Check if External Secrets CRDs already exist
  kubernetes.core.k8s_info:
    kind: CustomResourceDefinition
    name: externalsecrets.external-secrets.io
  register: eso_crd_check
  ignore_errors: true

- name: Check for ESO deployment via Helm
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: external-secrets-system
    name: external-secrets
  register: eso_helm_deployment
  ignore_errors: true

- name: Check for ESO deployment via OLM
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: external-secrets-operator
  register: eso_olm_deployments
  ignore_errors: true

- name: Set ESO installation facts
  set_fact:
    eso_installed_olm_openshift_operators: "{{ eso_subscription_openshift_operators.resources | length > 0 }}"
    eso_installed_olm_dedicated: "{{ eso_subscription_dedicated.resources | length > 0 }}"
    eso_installed_helm: "{{ eso_helm_deployment.resources | length > 0 }}"
    eso_running_olm: "{{ eso_olm_deployments.resources | length > 0 }}"
    eso_crds_exist: "{{ eso_crd_check.resources | length > 0 }}"

- name: Display External Secrets Operator status
  debug:
    msg: |
      External Secrets Operator Status:
      {% if eso_installed_olm_openshift_operators or eso_installed_olm_dedicated %}
        ✅ Already installed via OLM
        {% if eso_installed_olm_openshift_operators %}
        - Location: openshift-operators namespace
        - CSV: {{ eso_subscription_openshift_operators.resources[0].status.installedCSV | default('unknown') }}
        {% endif %}
        {% if eso_installed_olm_dedicated %}
        - Location: external-secrets-operator namespace (dedicated)
        - CSV: {{ eso_subscription_dedicated.resources[0].status.installedCSV | default('unknown') }}
        {% endif %}
        {% if eso_running_olm %}
        - Running Pods: {{ eso_olm_deployments.resources | length }}
        {% endif %}
      {% elif eso_installed_helm %}
        ✅ Already installed via Helm in external-secrets-system namespace
      {% elif eso_crds_exist %}
        ℹ️ CRDs already exist - assuming ESO is installed
      {% else %}
        ⏳ Not installed - will deploy via OLM (preferred for OpenShift)
      {% endif %}

- name: Deploy External Secrets Operator if not installed
  block:
    - name: Check if External Secrets Helm repository exists
      command: helm repo list -o json
      register: helm_repos
      changed_when: false
      ignore_errors: true

    - name: Add External Secrets Helm repository if not exists
      kubernetes.core.helm_repository:
        name: external-secrets
        repo_url: https://charts.external-secrets.io
        state: present
      when: "'external-secrets' not in (helm_repos.stdout | from_json | map(attribute='name') | list)"
      ignore_errors: true

    - name: Create external-secrets-system namespace
      kubernetes.core.k8s:
        name: external-secrets-system
        api_version: v1
        kind: Namespace
        state: present

    - name: Install External Secrets Operator via Helm
      kubernetes.core.helm:
        name: external-secrets
        chart_ref: external-secrets/external-secrets
        release_namespace: external-secrets-system
        create_namespace: true
        values:
          installCRDs: true
        wait: true
        wait_timeout: 5m

    - name: Wait for External Secrets Operator deployment to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: external-secrets-system
        name: external-secrets
      register: eso_deployment
      until:
        - eso_deployment.resources | length > 0
        - eso_deployment.resources[0].status.readyReplicas | default(0) > 0
      retries: 10
      delay: 30

    - name: Verify ExternalSecret CRD is available
      kubernetes.core.k8s_info:
        kind: CustomResourceDefinition
        name: externalsecrets.external-secrets.io
      register: eso_crd
      until: eso_crd.resources | length > 0
      retries: 5
      delay: 10

    - name: Verify SecretStore CRD is available
      kubernetes.core.k8s_info:
        kind: CustomResourceDefinition
        name: secretstores.external-secrets.io
      register: secretstore_crd
      until: secretstore_crd.resources | length > 0
      retries: 5
      delay: 10

    - name: Log External Secrets Operator deployment success
      debug:
        msg: |
          ✅ External Secrets Operator deployed successfully
          - Namespace: external-secrets-system
          - Version: v0.11.0+
          - CRDs: ExternalSecret, SecretStore, ClusterSecretStore, and 14+ generators
          - Ready for model-storage-config ExternalSecret creation

  when:
    - not eso_installed_olm_openshift_operators
    - not eso_installed_olm_dedicated
    - not eso_installed_helm
    - not eso_crds_exist
  rescue:
    - name: Log External Secrets Operator deployment failure
      debug:
        msg: |
          ⚠️ Failed to deploy External Secrets Operator
          - Check cluster connectivity
          - Verify Helm repository access
          - Check openshift-operators namespace permissions
          - Manual intervention may be required

- name: Verify External Secrets Operator is ready (check both OLM and Helm deployments)
  block:
    - name: Check ESO in external-secrets-operator namespace (OLM)
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: external-secrets-operator
      register: eso_final_check_olm
      ignore_errors: true

    - name: Check ESO in external-secrets-system namespace (Helm)
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: external-secrets-system
        name: external-secrets
      register: eso_final_check_helm
      ignore_errors: true

    - name: Set final ESO status
      set_fact:
        eso_is_ready: "{{ (eso_final_check_olm.resources | length > 0 and eso_final_check_olm.resources | selectattr('status.readyReplicas', 'defined') | selectattr('status.readyReplicas', '>', 0) | list | length > 0) or (eso_final_check_helm.resources | length > 0 and eso_final_check_helm.resources[0].status.readyReplicas | default(0) > 0) }}"
        eso_deployment_method: "{{ 'OLM' if (eso_final_check_olm.resources | length > 0) else ('Helm' if (eso_final_check_helm.resources | length > 0) else 'Unknown') }}"
        eso_namespace: "{{ 'external-secrets-operator' if (eso_final_check_olm.resources | length > 0) else ('external-secrets-system' if (eso_final_check_helm.resources | length > 0) else 'Unknown') }}"

- name: Display final External Secrets Operator status
  debug:
    msg: |
      External Secrets Operator Final Status:
      {% if eso_is_ready %}
        ✅ READY - Deployment healthy
        - Deployment Method: {{ eso_deployment_method }}
        - Namespace: {{ eso_namespace }}
        {% if eso_deployment_method == 'OLM' %}
        - Check logs: oc logs -f deployment/external-secrets-operator-controller-manager -n {{ eso_namespace }}
        {% else %}
        - Check logs: oc logs -f deployment/external-secrets -n {{ eso_namespace }}
        {% endif %}
      {% else %}
        ⚠️ NOT READY - External Secrets Operator not found or not healthy
        - Try checking both namespaces: external-secrets-operator (OLM) and external-secrets-system (Helm)
      {% endif %}

# ============================================================
# CONFIGURE ESO OPERATORCONFIG (REQUIRED FOR OLM DEPLOYMENTS)
# ============================================================
# Reference: https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/security_and_compliance/external-secrets-operator-for-red-hat-openshift
# The OperatorConfig CR enables webhook validation, metrics, and other ESO features

- name: Configure External Secrets Operator (OLM requires OperatorConfig)
  when: eso_is_ready and eso_deployment_method == 'OLM'
  block:
    - name: Check if OperatorConfig already exists
      kubernetes.core.k8s_info:
        api_version: operator.external-secrets.io/v1alpha1
        kind: OperatorConfig
        name: cluster
        namespace: "{{ eso_namespace }}"
      register: eso_operatorconfig_check
      ignore_errors: true

    - name: Create OperatorConfig if not exists
      when: eso_operatorconfig_check.resources | length == 0
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: operator.external-secrets.io/v1alpha1
          kind: OperatorConfig
          metadata:
            name: cluster
            namespace: "{{ eso_namespace }}"
          spec:
            # Enable Prometheus metrics
            prometheus:
              enabled: true
              service:
                port: 8080

            # Resource settings for ESO controller
            resources:
              requests:
                cpu: 10m
                memory: 96Mi
              limits:
                cpu: 100m
                memory: 256Mi

            # Webhook configuration - enables validation of ExternalSecrets
            webhook:
              create: true
              port: 9443
              secretName: external-secrets-webhook
      register: eso_operatorconfig_created

    - name: Wait for OperatorConfig to reconcile
      when: eso_operatorconfig_created.changed | default(false)
      pause:
        seconds: 15

    - name: Check for webhook service creation
      kubernetes.core.k8s_info:
        kind: Service
        namespace: "{{ eso_namespace }}"
      register: eso_services
      until: eso_services.resources | selectattr('metadata.name', 'search', 'webhook') | list | length > 0
      retries: 6
      delay: 10
      ignore_errors: true

    - name: Check for ValidatingWebhookConfiguration
      kubernetes.core.k8s_info:
        kind: ValidatingWebhookConfiguration
      register: eso_webhooks
      ignore_errors: true

    - name: Display OperatorConfig status
      debug:
        msg: |
          OperatorConfig Status:
          {% if eso_operatorconfig_check.resources | length > 0 %}
            ✅ OperatorConfig already exists
          {% elif eso_operatorconfig_created.changed | default(false) %}
            ✅ OperatorConfig created successfully
          {% else %}
            ℹ️ OperatorConfig check skipped (not OLM deployment)
          {% endif %}

          Webhook Resources:
          {% if eso_services.resources | selectattr('metadata.name', 'search', 'webhook') | list | length > 0 %}
            ✅ Webhook service created
          {% else %}
            ⚠️ Webhook service not found - ExternalSecrets may fail validation
          {% endif %}

          {% if eso_webhooks.resources | selectattr('metadata.name', 'search', 'external-secrets') | list | length > 0 %}
            ✅ ValidatingWebhookConfiguration found
          {% else %}
            ℹ️ ValidatingWebhookConfiguration not found (may be created by operator later)
          {% endif %}

- name: Check if external-secrets-system namespace exists
  kubernetes.core.k8s_info:
    kind: Namespace
    name: external-secrets-system
  register: eso_namespace
  ignore_errors: true

- name: Check if External Secrets OperatorConfig instance exists
  kubernetes.core.k8s_info:
    kind: OperatorConfig
    namespace: external-secrets-system
    name: default
  register: eso_operatorconfig
  ignore_errors: true
  when:
    - eso_namespace.resources | length > 0
    - eso_deployment_method == 'OLM'  # Only check for OperatorConfig with OLM installations

- name: Create External Secrets OperatorConfig instance if not exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: operator.external-secrets.io/v1alpha1
      kind: OperatorConfig
      metadata:
        name: default
        namespace: external-secrets-system
      spec:
        log:
          level: info
  when:
    - eso_namespace.resources | length > 0
    - eso_operatorconfig.resources | default([]) | length == 0
    - eso_deployment_method == 'OLM'  # Only create for OLM installations, not Helm

- name: Wait for External Secrets Operator to stabilize after OperatorConfig creation
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: external-secrets-system
    name: external-secrets
  register: eso_after_config
  until:
    - eso_after_config.resources | length > 0
    - eso_after_config.resources[0].status.readyReplicas | default(0) > 0
  retries: 10
  delay: 10
  when:
    - eso_namespace.resources | length > 0
    - eso_operatorconfig.resources | default([]) | length == 0
    - eso_deployment_method == 'OLM'  # Only wait if we created OperatorConfig for OLM
  ignore_errors: true

- name: Display OperatorConfig creation status
  debug:
    msg: |
      External Secrets OperatorConfig Status:
      {% if eso_namespace.resources | length == 0 %}
        ⚠️ Namespace external-secrets-system does not exist - skipping OperatorConfig
      {% elif eso_operatorconfig.resources | default([]) | length > 0 %}
        ✅ OperatorConfig already exists
      {% else %}
        ✅ OperatorConfig created successfully
      {% endif %}
