---
# Manage credentials

- name: Create RBAC for secrets
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: Role
      metadata:
        name: secrets-manager
        namespace: "{{ validated_patterns_secrets_namespace }}"
      rules:
        - apiGroups: [""]
          resources: ["secrets"]
          verbs: ["get", "list", "create", "update", "patch"]

# Auto-discover Gitea credentials from Gitea CR
# This avoids manual credential configuration and ensures correct passwords
- name: Check for Gitea installation
  kubernetes.core.k8s_info:
    api_version: pfe.rhpds.com/v1
    kind: Gitea
    namespace: gitea
  register: gitea_instances
  ignore_errors: true

- name: Get Gitea admin credentials from CR status
  set_fact:
    gitea_admin_user: "{{ gitea_instances.resources[0].spec.giteaAdminUser }}"
    gitea_admin_password: "{{ gitea_instances.resources[0].status.adminPassword }}"
  when:
    - gitea_instances.resources is defined
    - gitea_instances.resources | length > 0
    - gitea_instances.resources[0].status.adminPassword is defined

- name: Create gitea-credentials-source secret for ExternalSecrets
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: gitea-credentials-source
        namespace: "{{ validated_patterns_secrets_namespace }}"
        labels:
          app.kubernetes.io/name: gitea-credentials-source
          app.kubernetes.io/component: external-secrets
          app.kubernetes.io/managed-by: ansible
      type: Opaque
      stringData:
        username: "{{ gitea_admin_user }}"
        password: "{{ gitea_admin_password }}"
  when:
    - gitea_admin_user is defined
    - gitea_admin_password is defined
    - validated_patterns_create_gitea_credentials | default(true)

- name: Create git-credentials-source secret for BuildConfigs
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: git-credentials-source
        namespace: "{{ validated_patterns_secrets_namespace }}"
        labels:
          app.kubernetes.io/name: git-credentials-source
          app.kubernetes.io/component: external-secrets
          app.kubernetes.io/managed-by: ansible
      type: kubernetes.io/basic-auth
      stringData:
        username: "{{ gitea_admin_user }}"
        password: "{{ gitea_admin_password }}"
  when:
    - gitea_admin_user is defined
    - gitea_admin_password is defined
    - validated_patterns_create_gitea_credentials | default(true)

- name: Display credential management status
  debug:
    msg: |
      âœ… Credentials managed:
      - RBAC: Configured
      - Secrets namespace: {{ validated_patterns_secrets_namespace }}
      - Gitea credentials auto-discovered: {{ gitea_admin_user is defined }}
      {% if gitea_admin_user is defined %}
      - gitea-credentials-source: Created
      - git-credentials-source: Created
      {% endif %}
      - Ready for credential storage
