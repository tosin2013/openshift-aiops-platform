---
# Deploy GitHub credentials for notebook validation
# The source secret (github-pat-credentials-source) should be created by:
#   make load-secrets (reads from .env file)
#
# The ExternalSecret (in Helm chart) syncs from source to target secret
# Reference: charts/hub/templates/externalsecrets.yaml

- name: Check if GitHub PAT source secret exists
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: github-pat-credentials-source
    namespace: "{{ notebooks_validation_namespace }}"
  register: github_source_secret
  failed_when: false

- name: Display GitHub credentials status
  debug:
    msg: |
      {% if github_source_secret.resources | length > 0 %}
      ✅ GitHub PAT source secret found (github-pat-credentials-source)
         The ExternalSecret will sync this to github-pat-credentials for notebook validation.
      {% else %}
      ⚠️  GitHub PAT source secret not found.

         To create it, ensure GITHUB_PAT is set in .env and run:
           make load-secrets

         Or create manually:
           oc create secret generic github-pat-credentials-source \
             --from-literal=username=<your-github-username> \
             --from-literal=password=<your-github-pat> \
             -n {{ notebooks_validation_namespace }}

         Note: This is only required for private notebook repositories.
         Public repositories (like openshift-aiops-platform) don't need credentials.
      {% endif %}

- name: Check if ExternalSecret exists for GitHub credentials
  kubernetes.core.k8s_info:
    api_version: external-secrets.io/v1beta1
    kind: ExternalSecret
    name: github-pat-credentials
    namespace: "{{ notebooks_validation_namespace }}"
  register: github_external_secret
  failed_when: false

- name: Display ExternalSecret status
  debug:
    msg: |
      {% if github_external_secret.resources | length > 0 %}
      ✅ ExternalSecret 'github-pat-credentials' exists
         Status: {{ github_external_secret.resources[0].status.conditions | default([]) | selectattr('type', 'equalto', 'Ready') | map(attribute='status') | first | default('Unknown') }}
      {% else %}
      ℹ️  ExternalSecret 'github-pat-credentials' not found.
         It will be created by the Helm chart deployment (ArgoCD sync).
      {% endif %}
  when: github_external_secret.resources is defined

- name: Fail if credentials required but source secret missing
  fail:
    msg: |
      GitHub credentials are required but source secret 'github-pat-credentials-source' not found.

      Please run: make load-secrets

      Or create the secret manually with your GitHub PAT.
  when:
    - require_github_credentials | default(false) | bool
    - github_source_secret.resources | length == 0
