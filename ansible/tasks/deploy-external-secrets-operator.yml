---
# Ansible Task: Deploy External Secrets Operator
# Purpose: Check if External Secrets Operator is installed, deploy if missing
# Used by: ansible/playbooks/deploy_and_cleanup_e2e.yml
# For: Future cluster deployments

- name: Check if External Secrets Operator is installed
  kubernetes.core.k8s_info:
    kind: Subscription
    namespace: openshift-operators
    name: external-secrets-operator
  register: eso_subscription
  ignore_errors: true

- name: Display External Secrets Operator status
  debug:
    msg: |
      External Secrets Operator Status:
      {% if eso_subscription.resources | length > 0 %}
        ✅ Already installed ({{ eso_subscription.resources[0].status.installedCSV }})
      {% else %}
        ⏳ Not installed - will deploy
      {% endif %}

- name: Deploy External Secrets Operator if not installed
  block:
    - name: Add External Secrets Helm repository
      kubernetes.core.helm_repository:
        name: external-secrets
        repo_url: https://charts.external-secrets.io
        state: present

    - name: Create external-secrets-system namespace
      kubernetes.core.k8s:
        name: external-secrets-system
        api_version: v1
        kind: Namespace
        state: present

    - name: Install External Secrets Operator via Helm
      kubernetes.core.helm:
        name: external-secrets
        chart_ref: external-secrets/external-secrets
        release_namespace: external-secrets-system
        create_namespace: true
        values:
          installCRDs: true
        wait: true
        wait_timeout: 5m

    - name: Wait for External Secrets Operator deployment to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: external-secrets-system
        name: external-secrets
      register: eso_deployment
      until:
        - eso_deployment.resources | length > 0
        - eso_deployment.resources[0].status.readyReplicas | default(0) > 0
      retries: 10
      delay: 30

    - name: Verify ExternalSecret CRD is available
      kubernetes.core.k8s_info:
        kind: CustomResourceDefinition
        name: externalsecrets.external-secrets.io
      register: eso_crd
      until: eso_crd.resources | length > 0
      retries: 5
      delay: 10

    - name: Verify SecretStore CRD is available
      kubernetes.core.k8s_info:
        kind: CustomResourceDefinition
        name: secretstores.external-secrets.io
      register: secretstore_crd
      until: secretstore_crd.resources | length > 0
      retries: 5
      delay: 10

    - name: Log External Secrets Operator deployment success
      debug:
        msg: |
          ✅ External Secrets Operator deployed successfully
          - Namespace: external-secrets-system
          - Version: v0.11.0+
          - CRDs: ExternalSecret, SecretStore, ClusterSecretStore, and 14+ generators
          - Ready for model-storage-config ExternalSecret creation

  when: eso_subscription.resources | length == 0
  rescue:
    - name: Log External Secrets Operator deployment failure
      debug:
        msg: |
          ⚠️ Failed to deploy External Secrets Operator
          - Check cluster connectivity
          - Verify Helm repository access
          - Check openshift-operators namespace permissions
          - Manual intervention may be required

- name: Verify External Secrets Operator is ready
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: external-secrets-system
    name: external-secrets
  register: eso_final_check
  until:
    - eso_final_check.resources | length > 0
    - eso_final_check.resources[0].status.readyReplicas | default(0) > 0
  retries: 5
  delay: 10
  ignore_errors: true

- name: Display final External Secrets Operator status
  debug:
    msg: |
      External Secrets Operator Final Status:
      {% if eso_final_check.resources | length > 0 and eso_final_check.resources[0].status.readyReplicas | default(0) > 0 %}
        ✅ READY - Deployment healthy
        - Ready Replicas: {{ eso_final_check.resources[0].status.readyReplicas }}
        - Available Replicas: {{ eso_final_check.resources[0].status.availableReplicas }}
      {% else %}
        ⚠️ NOT READY - Check logs with: oc logs -f deployment/external-secrets -n external-secrets-system
      {% endif %}
