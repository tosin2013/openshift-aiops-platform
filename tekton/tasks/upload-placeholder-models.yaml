apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: upload-placeholder-models
  namespace: openshift-pipelines
  labels:
    app.kubernetes.io/name: upload-placeholder-models
    app.kubernetes.io/part-of: s3-configuration
spec:
  description: |
    Uploads placeholder models to S3 for testing InferenceServices.
    Creates minimal model files that can be used for validation.

    Models created:
    - anomaly-detector-model (placeholder)
    - predictive-analytics-model (placeholder)

  params:
    - name: namespace
      type: string
      default: self-healing-platform
      description: Target namespace for model upload
    - name: secret-name
      type: string
      default: model-storage-config
      description: Name of the secret containing S3 credentials
    - name: model-bucket
      type: string
      default: model-storage
      description: S3 bucket name for models

  steps:
    - name: create-and-upload-models
      image: quay.io/takinosh/maintenance-tools:latest
      script: |
        #!/bin/bash
        set -e

        NAMESPACE="$(params.namespace)"
        SECRET_NAME="$(params.secret-name)"
        MODEL_BUCKET="$(params.model-bucket)"

        echo "=== Uploading Placeholder Models ==="
        echo "Namespace: $NAMESPACE"
        echo "Bucket: $MODEL_BUCKET"

        # Extract S3 credentials
        AWS_ACCESS_KEY_ID=$(oc get secret "$SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.AWS_ACCESS_KEY_ID}' | base64 -d)
        AWS_SECRET_ACCESS_KEY=$(oc get secret "$SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.AWS_SECRET_ACCESS_KEY}' | base64 -d)
        AWS_S3_ENDPOINT=$(oc get secret "$SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.AWS_S3_ENDPOINT}' | base64 -d)

        export AWS_ACCESS_KEY_ID
        export AWS_SECRET_ACCESS_KEY
        export AWS_DEFAULT_REGION=us-east-1

        # Install AWS CLI if needed
        echo "Checking AWS CLI..."
        which aws &>/dev/null || (pip install awscli &>/dev/null || pip3 install awscli &>/dev/null)

        # Create temporary directory for models
        TEMP_DIR=$(mktemp -d)
        trap "rm -rf $TEMP_DIR" EXIT

        echo "Creating placeholder models..."

        # Create simple placeholder model files
        echo "placeholder-model-v1" > "$TEMP_DIR/anomaly-detector-model.pkl"
        echo "placeholder-model-v1" > "$TEMP_DIR/predictive-analytics-model.pkl"

        echo "✅ Created placeholder models"

        # Upload models to S3
        echo "Uploading models to S3..."

        aws s3 cp "$TEMP_DIR/anomaly-detector-model.pkl" \
          "s3://$MODEL_BUCKET/anomaly-detector-model.pkl" \
          --endpoint-url "$AWS_S3_ENDPOINT" \
          --no-verify-ssl 2>/dev/null || echo "⚠️  WARNING: Could not upload anomaly detector model"

        aws s3 cp "$TEMP_DIR/predictive-analytics-model.pkl" \
          "s3://$MODEL_BUCKET/predictive-analytics-model.pkl" \
          --endpoint-url "$AWS_S3_ENDPOINT" \
          --no-verify-ssl 2>/dev/null || echo "⚠️  WARNING: Could not upload predictive analytics model"

        echo "✅ PASS: Models uploaded to S3"

        echo "=== Model Upload Complete ==="
