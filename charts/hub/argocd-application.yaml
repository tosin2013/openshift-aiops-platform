apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: self-healing-platform
  namespace: openshift-gitops
  # Finalizers ensure proper cleanup
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  # Project for RBAC
  project: default

  # Source configuration
  source:
    # Git repository URL
    repoURL: https://gitea-with-admin-gitea.apps.cluster-fn2qb.fn2qb.sandbox1343.opentlc.com/opentlc-mgr/openshift-aiops-platform.git

    # Target branch
    targetRevision: main

    # Path to Helm chart
    path: charts/hub

    # Helm configuration
    helm:
      # Values files to use (relative to repo root, not chart path)
      # NOTE: ArgoCD resolves paths relative to repo root when using ../../
      valueFiles:
        - ../../values-global.yaml
        - ../../values-hub.yaml
        - values-notebooks-validation.yaml

      # Additional Helm parameters
      parameters: []

      # Helm release name
      releaseName: self-healing-platform

  # Destination configuration
  destination:
    # Kubernetes cluster (local cluster)
    server: https://kubernetes.default.svc

    # Target namespace
    namespace: self-healing-platform

  # Sync policy configuration
  syncPolicy:
    # Automated sync
    automated:
      # Prune resources that are no longer in Git
      prune: true

      # Self-heal: automatically sync when cluster state diverges
      selfHeal: true

      # Allow empty: allow syncing to empty Git repository
      allowEmpty: false

    # Sync options
    syncOptions:
      # Create namespace if it doesn't exist
      - CreateNamespace=true

      # Respect ignore differences
      - RespectIgnoreDifferences=true

    # Retry configuration
    retry:
      # Limit number of retries
      limit: 5

      # Backoff configuration
      backoff:
        # Initial duration
        duration: 5s

        # Maximum duration
        maxDuration: 3m

        # Factor to multiply duration by
        factor: 2

  # Ignore differences configuration
  ignoreDifferences:
    # Ignore differences in managed fields
    - group: "*"
      kind: "*"
      managedFieldsManagers:
        - kube-controller-manager
        - kubectl-client-side-apply

  # Notification configuration
  info:
    - name: Documentation
      value: https://github.com/openshift-aiops/self-healing-platform/docs
    - name: Support
      value: https://github.com/openshift-aiops/self-healing-platform/issues

---
# ServiceAccount for ArgoCD to access the repository
apiVersion: v1
kind: ServiceAccount
metadata:
  name: self-healing-platform-argocd
  namespace: openshift-gitops

---
# Role for ArgoCD to manage resources in self-healing-platform namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: self-healing-platform-argocd
  namespace: self-healing-platform
rules:
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["*"]

---
# RoleBinding to grant ArgoCD permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: self-healing-platform-argocd
  namespace: self-healing-platform
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: self-healing-platform-argocd
subjects:
  - kind: ServiceAccount
    name: argocd-application-controller
    namespace: openshift-gitops

---
# ClusterRole for ArgoCD to read cluster-wide resources
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: self-healing-platform-argocd
rules:
  - apiGroups: [""]
    resources: ["nodes", "namespaces"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["deployments", "daemonsets", "statefulsets", "replicasets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["batch"]
    resources: ["jobs", "cronjobs"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["monitoring.coreos.com"]
    resources: ["servicemonitors", "prometheusrules"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["serving.kserve.io"]
    resources: ["inferenceservices"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["kubeflow.org"]
    resources: ["notebooks"]
    verbs: ["get", "list", "watch"]

---
# ClusterRoleBinding for ArgoCD
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: self-healing-platform-argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: self-healing-platform-argocd
subjects:
  - kind: ServiceAccount
    name: argocd-application-controller
    namespace: openshift-gitops
