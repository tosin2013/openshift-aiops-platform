{{- if .Values.operators }}
{{- if index .Values.operators "external-secrets" }}
{{- if (index .Values.operators "external-secrets").enabled }}
---
apiVersion: v1
kind: Namespace
metadata:
  name: {{ (index .Values.operators "external-secrets").namespace | default "external-secrets-operator" }}
  labels:
    openshift.io/cluster-monitoring: "true"
    pod-security.kubernetes.io/enforce: baseline
    pod-security.kubernetes.io/audit: baseline
    pod-security.kubernetes.io/warn: baseline
    app.kubernetes.io/name: external-secrets-operator
    app.kubernetes.io/part-of: {{ .Values.global.pattern | default "self-healing-platform" }}
    app.kubernetes.io/managed-by: validated-patterns
---
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: external-secrets-operator
  namespace: {{ (index .Values.operators "external-secrets").namespace | default "external-secrets-operator" }}
  labels:
    app.kubernetes.io/name: external-secrets-operator
    app.kubernetes.io/part-of: {{ .Values.global.pattern | default "self-healing-platform" }}
spec:
  targetNamespaces:
  - {{ (index .Values.operators "external-secrets").namespace | default "external-secrets-operator" }}
---
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: external-secrets-operator
  namespace: {{ (index .Values.operators "external-secrets").namespace | default "external-secrets-operator" }}
  labels:
    app.kubernetes.io/name: external-secrets-operator
    app.kubernetes.io/part-of: {{ .Values.global.pattern | default "self-healing-platform" }}
spec:
  channel: {{ (index .Values.operators "external-secrets").channel | default "alpha" }}
  name: external-secrets-operator
  source: {{ (index .Values.operators "external-secrets").source | default "community-operators" }}
  sourceNamespace: openshift-marketplace
  installPlanApproval: Automatic
  {{- if (index .Values.operators "external-secrets").version }}
  startingCSV: external-secrets-operator.{{ (index .Values.operators "external-secrets").version }}
  {{- end }}
---
# OperatorConfig - Applied after operator installation
# This configures the External Secrets Operator Helm chart
apiVersion: operator.external-secrets.io/v1alpha1
kind: OperatorConfig
metadata:
  name: cluster
  namespace: {{ (index .Values.operators "external-secrets").namespace | default "external-secrets-operator" }}
  labels:
    app.kubernetes.io/name: external-secrets-operator
    app.kubernetes.io/part-of: {{ .Values.global.pattern | default "self-healing-platform" }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"  # Apply after operator is installed
spec:
  {{- if (index .Values.operators "external-secrets").config }}
  {{- if (index .Values.operators "external-secrets").config.prometheus }}
  # Prometheus monitoring
  prometheus:
    enabled: {{ (index .Values.operators "external-secrets").config.prometheus.enabled | default true }}
    service:
      port: {{ (index .Values.operators "external-secrets").config.prometheus.port | default 8080 }}
  {{- end }}

  {{- if (index .Values.operators "external-secrets").config.resources }}
  # Resource limits for the main controller
  resources:
    {{- toYaml (index .Values.operators "external-secrets").config.resources | nindent 4 }}
  {{- else }}
  resources:
    requests:
      cpu: 10m
      memory: 96Mi
    limits:
      cpu: 100m
      memory: 256Mi
  {{- end }}
  {{- end }}

  # Enable cluster-wide resources
  crds:
    createClusterExternalSecret: true
    createClusterSecretStore: true

  # Process cluster-wide stores and secrets
  processClusterStore: true
  processClusterExternalSecret: true

  # Leader election for HA
  leaderElect: true

  # Number of concurrent reconciliations
  concurrent: {{ (index .Values.operators "external-secrets").config.concurrent | default 1 }}

  # Webhook configuration
  webhook:
    create: true
    replicaCount: 1
    certCheckInterval: "5m"
    certDir: "/tmp/certs"
    prometheus:
      enabled: true
      service:
        port: 8080
    resources:
      requests:
        cpu: 10m
        memory: 96Mi
      limits:
        cpu: 100m
        memory: 256Mi

  # Certificate controller configuration
  certController:
    create: true
    requeueInterval: "5m"
    prometheus:
      enabled: true
      service:
        port: 8080
    resources:
      requests:
        cpu: 10m
        memory: 96Mi
      limits:
        cpu: 100m
        memory: 256Mi
{{- end }}
{{- end }}
{{- end }}
