{{- if and .Values.objectStore.enabled (eq .Values.secrets.backend "external-secrets") }}
---
# Job to initialize model-storage source secret with NooBaa credentials
# This runs before s3-bucket-setup and creates the source secret that ExternalSecret reads from
apiVersion: batch/v1
kind: Job
metadata:
  name: noobaa-credentials-init
  namespace: {{ .Values.main.namespace }}
  labels:
    app.kubernetes.io/name: noobaa-credentials-init
    app.kubernetes.io/component: object-store
    app.kubernetes.io/part-of: self-healing-platform
  annotations:
    description: "Initializes model-storage source secret with NooBaa S3 credentials"
    # Sync wave -7: Must run before SecretStore (-5) and ExternalSecrets (-4)
    # NOTE: Hook removed to avoid circular dependency with ServiceAccount
    argocd.argoproj.io/sync-wave: "-7"
spec:
  backoffLimit: 5
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app.kubernetes.io/name: noobaa-credentials-init
        app.kubernetes.io/component: object-store
    spec:
      serviceAccountName: self-healing-operator
      restartPolicy: Never
      containers:
      - name: credentials-initializer
        image: image-registry.openshift-image-registry.svc:5000/openshift/tools:latest
        imagePullPolicy: IfNotPresent
        command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "=========================================="
          echo "NooBaa Credentials Initialization"
          echo "=========================================="

          # Check if NooBaa admin secret exists
          if ! oc get secret noobaa-admin -n openshift-storage &>/dev/null; then
            echo "❌ ERROR: NooBaa admin secret not found in openshift-storage namespace"
            echo "Please ensure OpenShift Data Foundation is installed and NooBaa is running"
            exit 1
          fi

          echo "✅ NooBaa admin secret found"

          # Get NooBaa credentials
          AWS_ACCESS_KEY_ID=$(oc get secret noobaa-admin -n openshift-storage -o jsonpath='{.data.AWS_ACCESS_KEY_ID}' | base64 -d)
          AWS_SECRET_ACCESS_KEY=$(oc get secret noobaa-admin -n openshift-storage -o jsonpath='{.data.AWS_SECRET_ACCESS_KEY}' | base64 -d)

          # Get S3 route
          S3_ROUTE=$(oc get route s3 -n openshift-storage -o jsonpath='{.spec.host}' 2>/dev/null || echo "")

          if [ -z "$S3_ROUTE" ]; then
            echo "⚠️  WARNING: S3 route not found, using service endpoint"
            AWS_S3_ENDPOINT="https://s3.openshift-storage.svc:443"
          else
            AWS_S3_ENDPOINT="https://$S3_ROUTE"
            echo "✅ S3 route found: $AWS_S3_ENDPOINT"
          fi

          # Create or update model-storage source secret
          echo "Creating model-storage source secret..."

          cat <<EOF | oc apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: model-storage
            namespace: {{ .Values.main.namespace }}
            labels:
              app.kubernetes.io/name: model-storage
              app.kubernetes.io/component: credentials-source
              app.kubernetes.io/part-of: self-healing-platform
            annotations:
              description: "Source secret for NooBaa S3 credentials (read by ExternalSecret)"
          type: Opaque
          stringData:
            AWS_ACCESS_KEY_ID: "$AWS_ACCESS_KEY_ID"
            AWS_SECRET_ACCESS_KEY: "$AWS_SECRET_ACCESS_KEY"
            AWS_S3_ENDPOINT: "$AWS_S3_ENDPOINT"
          EOF

          echo "✅ model-storage source secret created/updated"
          echo ""
          echo "ExternalSecret will now sync these credentials to model-storage-config"
          echo "=========================================="

        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "200m"

{{- end }}
