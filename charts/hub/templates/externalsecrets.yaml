{{- if eq .Values.secrets.backend "external-secrets" }}
---
# ExternalSecret for Gitea Credentials
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: gitea-credentials
  namespace: {{ .Values.main.namespace }}
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: gitea-credentials
spec:
  refreshInterval: {{ .Values.secrets.externalSecrets.refreshInterval }}
  secretStoreRef:
    name: {{ .Values.secrets.externalSecrets.secretStore.name }}
    kind: {{ .Values.secrets.externalSecrets.secretStore.kind }}
  target:
    name: gitea-credentials
    creationPolicy: Owner
    template:
      type: kubernetes.io/basic-auth
      metadata:
        labels:
          app.kubernetes.io/name: gitea-credentials
  data:
  - secretKey: username
    remoteRef:
      key: gitea-credentials-source
      property: username
  - secretKey: password
    remoteRef:
      key: gitea-credentials-source
      property: password

---
# ExternalSecret for Git Credentials (BuildConfig source secret)
# Used by BuildConfigs to clone from Gitea repository
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: git-credentials
  namespace: {{ .Values.main.namespace }}
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: git-credentials
  annotations:
    argocd.argoproj.io/sync-wave: "-4"
spec:
  refreshInterval: {{ .Values.secrets.externalSecrets.refreshInterval }}
  secretStoreRef:
    name: {{ .Values.secrets.externalSecrets.secretStore.name }}
    kind: {{ .Values.secrets.externalSecrets.secretStore.kind }}
  target:
    name: git-credentials
    creationPolicy: Owner
    template:
      type: kubernetes.io/basic-auth
      metadata:
        labels:
          app.kubernetes.io/name: git-credentials
          app.kubernetes.io/component: build-credentials
  data:
  - secretKey: username
    remoteRef:
      key: gitea-credentials-source
      property: username
  - secretKey: password
    remoteRef:
      key: gitea-credentials-source
      property: password

{{- if and .Values.registry .Values.registry.credentials }}
---
# ExternalSecret for Registry Credentials
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: registry-credentials
  namespace: {{ .Values.main.namespace }}
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: registry-credentials
spec:
  refreshInterval: {{ .Values.secrets.externalSecrets.refreshInterval }}
  secretStoreRef:
    name: {{ .Values.secrets.externalSecrets.secretStore.name }}
    kind: {{ .Values.secrets.externalSecrets.secretStore.kind }}
  target:
    name: registry-credentials
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockercfg
      metadata:
        labels:
          app.kubernetes.io/name: registry-credentials
      data:
        .dockercfg: |
          {
            "{{ .remoteRef.data.server }}": {
              "username": "{{ .remoteRef.data.username }}",
              "password": "{{ .remoteRef.data.password }}",
              "email": "{{ .remoteRef.data.email }}"
            }
          }
  data:
  - secretKey: server
    remoteRef:
      key: registry-credentials-source
      property: server
  - secretKey: username
    remoteRef:
      key: registry-credentials-source
      property: username
  - secretKey: password
    remoteRef:
      key: registry-credentials-source
      property: password
  - secretKey: email
    remoteRef:
      key: registry-credentials-source
      property: email
{{- end }}

{{- if and .Values.database .Values.database.credentials }}
---
# ExternalSecret for Database Credentials
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: database-credentials
  namespace: {{ .Values.main.namespace }}
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: database-credentials
spec:
  refreshInterval: {{ .Values.secrets.externalSecrets.refreshInterval }}
  secretStoreRef:
    name: {{ .Values.secrets.externalSecrets.secretStore.name }}
    kind: {{ .Values.secrets.externalSecrets.secretStore.kind }}
  target:
    name: database-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: database-credentials
  data:
  - secretKey: username
    remoteRef:
      key: database-credentials-source
      property: username
  - secretKey: password
    remoteRef:
      key: database-credentials-source
      property: password
  - secretKey: host
    remoteRef:
      key: database-credentials-source
      property: host
  - secretKey: port
    remoteRef:
      key: database-credentials-source
      property: port
  - secretKey: database
    remoteRef:
      key: database-credentials-source
      property: database
{{- end }}

{{- if and .Values.objectStore .Values.objectStore.enabled }}
---
# ExternalSecret for Model Storage Configuration
# Reads credentials from ObjectBucketClaim secret in openshift-storage namespace
# Creates model-storage-config secret in self-healing-platform namespace
# Used by KServe InferenceServices and notebooks for S3 access
#
# Reference: ADR-024 - External Secrets for Model Storage
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: model-storage-config
  namespace: {{ .Values.main.namespace }}
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: model-storage-config
    app.kubernetes.io/part-of: self-healing-platform
  annotations:
    argocd.argoproj.io/sync-wave: "-4"
    # Don't fail ArgoCD sync if source secret doesn't exist yet
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  refreshInterval: {{ .Values.secrets.externalSecrets.refreshInterval }}
  secretStoreRef:
    name: {{ .Values.secrets.externalSecrets.secretStore.name }}
    kind: {{ .Values.secrets.externalSecrets.secretStore.kind }}
  target:
    name: model-storage-config
    creationPolicy: Owner
    template:
      engineVersion: v2
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: model-storage-config
          app.kubernetes.io/component: model-serving
          app.kubernetes.io/part-of: self-healing-platform
      data:
        # Static configuration values
        AWS_DEFAULT_REGION: "{{ .Values.objectStore.region | default "us-east-1" }}"
        MODEL_BUCKET: "{{ .Values.objectStore.buckets.models | default "model-storage" }}"
        AWS_S3_BUCKET: "{{ .Values.objectStore.buckets.models | default "model-storage" }}"  # Alias for workbench compatibility
        TRAINING_DATA_BUCKET: "{{ .Values.objectStore.buckets.trainingData | default "training-data" }}"
        INFERENCE_RESULTS_BUCKET: "{{ .Values.objectStore.buckets.inferenceResults | default "inference-results" }}"
        AWS_SSL_VERIFY: "{{ .Values.objectStore.sslVerify | default false }}"
        # Dynamic credentials from NooBaa (synced via .data section below)
        AWS_ACCESS_KEY_ID: "{{"{{"}} .AWS_ACCESS_KEY_ID {{"}}"}}"
        AWS_SECRET_ACCESS_KEY: "{{"{{"}} .AWS_SECRET_ACCESS_KEY {{"}}"}}"
        AWS_S3_ENDPOINT: "{{"{{"}} .AWS_S3_ENDPOINT {{"}}"}}"
  data:
  # AWS S3 Access Key from NooBaa/ODF credentials
  - secretKey: AWS_ACCESS_KEY_ID
    remoteRef:
      key: model-storage
      property: AWS_ACCESS_KEY_ID

  # AWS S3 Secret Key from NooBaa/ODF credentials
  - secretKey: AWS_SECRET_ACCESS_KEY
    remoteRef:
      key: model-storage
      property: AWS_SECRET_ACCESS_KEY

  # AWS S3 Endpoint from NooBaa/ODF (S3 route URL)
  - secretKey: AWS_S3_ENDPOINT
    remoteRef:
      key: model-storage
      property: AWS_S3_ENDPOINT

---
# ExternalSecret for KServe Storage Config
# This creates the storage-config secret in KServe format
# Used by KServe storage-initializer for S3 access
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: storage-config
  namespace: {{ .Values.main.namespace }}
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: storage-config
    app.kubernetes.io/part-of: self-healing-platform
  annotations:
    argocd.argoproj.io/sync-wave: "-4"
    # Don't fail ArgoCD sync if source secret doesn't exist yet
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
    description: "KServe storage-initializer S3 credentials"
spec:
  refreshInterval: {{ .Values.secrets.externalSecrets.refreshInterval }}
  secretStoreRef:
    name: {{ .Values.secrets.externalSecrets.secretStore.name }}
    kind: {{ .Values.secrets.externalSecrets.secretStore.kind }}
  target:
    name: storage-config
    creationPolicy: Owner
    template:
      engineVersion: v2
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: storage-config
          app.kubernetes.io/component: model-serving
          app.kubernetes.io/part-of: self-healing-platform
      data:
        # KServe format (uppercase)
        AWS_ACCESS_KEY_ID: "{{"{{"}} .AWS_ACCESS_KEY_ID {{"}}"}}"
        AWS_SECRET_ACCESS_KEY: "{{"{{"}} .AWS_SECRET_ACCESS_KEY {{"}}"}}"
        AWS_S3_ENDPOINT: "{{"{{"}} .AWS_S3_ENDPOINT {{"}}"}}"
        AWS_DEFAULT_REGION: "{{ .Values.objectStore.region | default "us-east-1" }}"
        AWS_S3_BUCKET: "{{ .Values.objectStore.buckets.models | default "model-storage" }}"
        # KServe format (camelCase - for older versions)
        awsAccessKeyID: "{{"{{"}} .AWS_ACCESS_KEY_ID {{"}}"}}"
        awsSecretAccessKey: "{{"{{"}} .AWS_SECRET_ACCESS_KEY {{"}}"}}"
  data:
  # Sync from the same source as model-storage-config
  - secretKey: AWS_ACCESS_KEY_ID
    remoteRef:
      key: model-storage
      property: AWS_ACCESS_KEY_ID
  - secretKey: AWS_SECRET_ACCESS_KEY
    remoteRef:
      key: model-storage
      property: AWS_SECRET_ACCESS_KEY
  - secretKey: AWS_S3_ENDPOINT
    remoteRef:
      key: model-storage
      property: AWS_S3_ENDPOINT
{{- end }}

{{- if and .Values.notebookValidation.enabled .Values.notebookValidation.requiresAuth }}
---
# ExternalSecret for Git Credentials (Notebook Validation)
# Used by Jupyter Notebook Validator Operator to access private notebooks
# Source: github-pat-credentials-source (or gitea credentials) secret in same namespace
# Target: github-pat-credentials secret for NotebookValidationJob
#
# NOTE: Only created if notebookValidation.requiresAuth is true
# For public repositories, this ExternalSecret is not needed
#
# Reference: https://github.com/tosin2013/jupyter-notebook-validator-operator
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: github-pat-credentials
  namespace: {{ .Values.main.namespace }}
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: github-credentials
    app.kubernetes.io/part-of: notebook-validation
  annotations:
    argocd.argoproj.io/sync-wave: "-3"
    description: "GitHub PAT for notebook validation repository access"
spec:
  refreshInterval: {{ .Values.secrets.externalSecrets.refreshInterval }}
  secretStoreRef:
    name: {{ .Values.secrets.externalSecrets.secretStore.name }}
    kind: {{ .Values.secrets.externalSecrets.secretStore.kind }}
  target:
    name: github-pat-credentials
    creationPolicy: Owner
    template:
      type: kubernetes.io/basic-auth
      metadata:
        labels:
          app.kubernetes.io/name: github-pat-credentials
          app.kubernetes.io/component: notebook-validation
          app.kubernetes.io/part-of: self-healing-platform
      data:
        username: "{{ "{{" }} .username {{ "}}" }}"
        password: "{{ "{{" }} .password {{ "}}" }}"
  data:
  # GitHub username
  - secretKey: username
    remoteRef:
      key: {{ .Values.notebookValidation.github.sourceSecretName | default "github-pat-credentials-source" }}
      property: username
  # GitHub Personal Access Token
  - secretKey: password
    remoteRef:
      key: {{ .Values.notebookValidation.github.sourceSecretName | default "github-pat-credentials-source" }}
      property: password
{{- end }}

{{- end }}
