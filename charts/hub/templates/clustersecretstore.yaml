{{- if and (eq .Values.secrets.backend "external-secrets") (.Values.secrets.clusterScoped) }}
---
# ClusterSecretStore for cross-namespace secret access
# Allows ExternalSecrets in any namespace to reference secrets from a central location
# Use case: Shared secrets (API keys, certificates) across multiple namespaces
# Sync wave -5: ClusterSecretStore must exist before ExternalSecrets use it
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: cluster-secrets
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: clustersecretstore
  annotations:
    argocd.argoproj.io/sync-wave: "-5"
spec:
  provider:
    kubernetes:
      # Use the same ServiceAccount from the pattern namespace
      auth:
        serviceAccount:
          name: {{ .Values.secrets.externalSecrets.serviceAccount.name }}
          namespace: {{ .Values.main.namespace }}
      # Central secrets namespace (can be overridden in ExternalSecret)
      remoteNamespace: {{ .Values.secrets.centralNamespace | default .Values.main.namespace }}
      {{- if .Values.secrets.externalSecrets.caProvider.enabled }}
      # CA certificate configuration for secure Kubernetes API communication
      server:
        caProvider:
          type: {{ .Values.secrets.externalSecrets.caProvider.type | default "ConfigMap" }}
          name: {{ .Values.secrets.externalSecrets.caProvider.name | default "kube-root-ca.crt" }}
          key: {{ .Values.secrets.externalSecrets.caProvider.key | default "ca.crt" }}
      {{- end }}

{{- end }}
