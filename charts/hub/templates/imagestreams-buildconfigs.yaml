{{- if .Values.imageBuilds.enabled }}
{{- /* Resolve git URL with fallback chain */ -}}
{{- $gitUrl := .Values.imageBuilds.gitRepository | default .Values.git.repoURL | default .Values.global.git.repoURL | default "" }}
{{- $gitRef := .Values.imageBuilds.gitRef | default .Values.git.revision | default .Values.global.git.revision | default "main" }}
{{- if $gitUrl }}
---
# ImageStream for coordination engine
apiVersion: image.openshift.io/v1
kind: ImageStream
metadata:
  name: coordination-engine
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ include "self-healing-platform.name" . }}
    app.kubernetes.io/component: coordination-engine
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
spec:
  lookupPolicy:
    local: true

---
# BuildConfig for coordination engine
apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: coordination-engine
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ include "self-healing-platform.name" . }}
    app.kubernetes.io/component: coordination-engine
spec:
  source:
    type: Git
    git:
      uri: {{ $gitUrl }}
      ref: {{ $gitRef }}
    contextDir: src/coordination-engine
    sourceSecret:
      name: {{ .Values.imageBuilds.gitCredentialsSecret }}
  strategy:
    type: Docker
    dockerStrategy:
      dockerfilePath: Dockerfile
      from:
        kind: DockerImage
        name: {{ .Values.imageBuilds.baseImage }}
  output:
    to:
      kind: ImageStreamTag
      name: coordination-engine:latest
  triggers:
    - type: ConfigChange
    - type: Generic
      generic:
        secret: coordination-engine-webhook-secret
        allowEnv: true
  runPolicy: Serial
  resources:
    limits:
      cpu: "1"
      memory: "1Gi"
    requests:
      cpu: "500m"
      memory: "512Mi"

---
# ImageStream for model serving
apiVersion: image.openshift.io/v1
kind: ImageStream
metadata:
  name: model-serving
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ include "self-healing-platform.name" . }}
    app.kubernetes.io/component: model-serving
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
spec:
  lookupPolicy:
    local: true

---
# BuildConfig for model serving
apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: model-serving
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ include "self-healing-platform.name" . }}
    app.kubernetes.io/component: model-serving
spec:
  source:
    type: Git
    git:
      uri: {{ $gitUrl }}
      ref: {{ $gitRef }}
    contextDir: src/models
    sourceSecret:
      name: {{ .Values.imageBuilds.gitCredentialsSecret }}
  strategy:
    type: Docker
    dockerStrategy:
      dockerfilePath: Dockerfile
      from:
        kind: DockerImage
        name: {{ .Values.imageBuilds.baseImage }}
  output:
    to:
      kind: ImageStreamTag
      name: model-serving:latest
  triggers:
    - type: ConfigChange
    - type: Generic
      generic:
        secret: model-serving-webhook-secret
        allowEnv: true
  runPolicy: Serial
  resources:
    limits:
      cpu: "1"
      memory: "1Gi"
    requests:
      cpu: "500m"
      memory: "512Mi"

---
# ImageStream for MCP server
apiVersion: image.openshift.io/v1
kind: ImageStream
metadata:
  name: mcp-server
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ include "self-healing-platform.name" . }}
    app.kubernetes.io/component: mcp-server
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
spec:
  lookupPolicy:
    local: true

---
# BuildConfig for MCP server
apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: mcp-server
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ include "self-healing-platform.name" . }}
    app.kubernetes.io/component: mcp-server
spec:
  source:
    type: Git
    git:
      uri: {{ $gitUrl }}
      ref: {{ $gitRef }}
    contextDir: src/mcp-server
    sourceSecret:
      name: {{ .Values.imageBuilds.gitCredentialsSecret }}
  strategy:
    type: Docker
    dockerStrategy:
      dockerfilePath: Dockerfile
  output:
    to:
      kind: ImageStreamTag
      name: mcp-server:latest
  triggers:
    - type: ConfigChange
    - type: Generic
      generic:
        secret: mcp-server-webhook-secret
        allowEnv: true
  runPolicy: Serial
  resources:
    limits:
      cpu: "1"
      memory: "1Gi"
    requests:
      cpu: "500m"
      memory: "512Mi"

{{- end }}{{/* end if $gitUrl */}}
{{- end }}{{/* end if .Values.imageBuilds.enabled */}}
