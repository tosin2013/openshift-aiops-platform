---
# Build and Publish Ansible Execution Environment to Quay.io
name: Build and Publish Execution Environment

'on':
  push:
    branches:
      - main
    tags:
      - 'v*'
      - 'release-*'
    paths:
      - 'execution-environment.yml'
      - 'files/requirements.yml'
      - 'files/requirements.txt'
      - 'files/bindep.txt'
      - 'ansible.cfg'
      - 'scripts/**'
      - '.github/workflows/build-ee.yml'
  workflow_dispatch:
    inputs:
      custom_tag:
        description: 'Custom image tag (optional, overrides automatic tag)'
        required: false
        type: string
      skip_push:
        description: 'Skip publishing to Quay.io (build and test only)'
        required: false
        type: boolean
        default: false
      verbosity:
        description: 'Build verbosity level (1-3)'
        required: false
        type: number
        default: 3

env:
  CONTAINER_ENGINE: podman
  TARGET_HUB: quay.io
  TARGET_NAME: takinosh/openshift-aiops-platform-ee
  PYTHON_VERSION: '3.11'

jobs:
  build-test:
    name: Build and Test EE
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.determine-tag.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Determine image tag
        id: determine-tag
        run: |
          # Priority: custom_tag > git tag > 'latest' (main) > branch name
          if [[ -n "${{ inputs.custom_tag }}" ]]; then
            TAG="${{ inputs.custom_tag }}"
            echo "Using custom tag from input: ${TAG}"
          elif [[ "${{ github.ref }}" == "refs/tags/"* ]]; then
            TAG="${{ github.ref_name }}"
            echo "Using git tag: ${TAG}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG="latest"
            echo "Using 'latest' for main branch"
          else
            # Sanitize branch name for Docker tag
            TAG=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
            echo "Using sanitized branch name: ${TAG}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Final image tag: ${TAG}"

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gettext-base podman
          python -m pip install --upgrade pip
          pip install ansible-builder ansible-navigator

      - name: Log in to registry.redhat.io (optional)
        continue-on-error: true
        env:
          REDHAT_REGISTRY_USER: ${{ secrets.REDHAT_REGISTRY_USER }}
          REDHAT_REGISTRY_PASSWORD: ${{ secrets.REDHAT_REGISTRY_PASSWORD }}
        run: |
          if [[ -n "$REDHAT_REGISTRY_USER" ]] && [[ -n "$REDHAT_REGISTRY_PASSWORD" ]]; then
            echo "Logging in to registry.redhat.io..."
            echo "$REDHAT_REGISTRY_PASSWORD" | podman login registry.redhat.io \
              --username "$REDHAT_REGISTRY_USER" --password-stdin
          else
            echo "Skipping registry.redhat.io login (credentials not provided)"
          fi

      - name: Generate ansible.cfg from template
        env:
          ANSIBLE_HUB_TOKEN: ${{ secrets.ANSIBLE_HUB_TOKEN }}
        run: |
          if [[ ! -f ansible.cfg ]]; then
            echo "Generating ansible.cfg from template..."
            envsubst < files/ansible.cfg.template > ansible.cfg
            echo "✅ ansible.cfg generated"
          else
            echo "ansible.cfg already exists"
          fi

          # Verify ansible.cfg was created and token was substituted
          echo "Verifying ansible.cfg..."
          if grep -q '\$ANSIBLE_HUB_TOKEN' ansible.cfg; then
            echo "❌ ERROR: Token placeholder not substituted in ansible.cfg"
            exit 1
          fi
          if grep -q 'token=' ansible.cfg; then
            echo "✅ Token field found in ansible.cfg"
          else
            echo "❌ ERROR: No token field in ansible.cfg"
            exit 1
          fi

      - name: Build execution environment
        env:
          ANSIBLE_HUB_TOKEN: ${{ secrets.ANSIBLE_HUB_TOKEN }}
        run: |
          echo "Building execution environment..."
          if [[ ! -f "execution-environment.yml" ]]; then
            echo "Error: execution-environment.yml not found"
            exit 1
          fi

          TAG="${{ steps.determine-tag.outputs.tag }}"
          echo "Building image: openshift-aiops-platform-ee:${TAG}"

          ansible-builder build \
            --tag openshift-aiops-platform-ee:${TAG} \
            --verbosity ${{ inputs.verbosity || 3 }} \
            --container-runtime ${{ env.CONTAINER_ENGINE }}

          echo "✅ Execution environment built successfully"
          echo "Image: openshift-aiops-platform-ee:${TAG}"

      - name: Test execution environment
        run: |
          TAG="${{ steps.determine-tag.outputs.tag }}"
          echo "Testing execution environment: openshift-aiops-platform-ee:${TAG}"

          echo "Verifying image exists locally:"
          ${{ env.CONTAINER_ENGINE }} images openshift-aiops-platform-ee:${TAG}

          echo -e "\nTesting Ansible version:"
          ${{ env.CONTAINER_ENGINE }} run --rm openshift-aiops-platform-ee:${TAG} ansible --version

          echo -e "\nTesting Ansible collections:"
          ${{ env.CONTAINER_ENGINE }} run --rm openshift-aiops-platform-ee:${TAG} ansible-galaxy collection list

          echo -e "\n✅ Execution environment test complete"

      - name: Verify Python packages
        run: |
          echo "Testing Python package availability..."
          ${{ env.CONTAINER_ENGINE }} run --rm \
            openshift-aiops-platform-ee:${{ steps.determine-tag.outputs.tag }} \
            python3 -c "import kubernetes, openshift, jmespath, requests; print('✅ Python packages OK')"

      - name: Verify system binaries
        run: |
          echo "Testing system binaries..."
          ${{ env.CONTAINER_ENGINE }} run --rm \
            openshift-aiops-platform-ee:${{ steps.determine-tag.outputs.tag }} \
            bash -c "which git && which tar && echo '✅ System binaries OK'"

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ steps.determine-tag.outputs.tag }}
          path: |
            context/_build
            context/Containerfile
          retention-days: 7
          if-no-files-found: ignore

  publish:
    name: Publish to Quay.io
    runs-on: ubuntu-latest
    needs: build-test
    if: |
      (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')) &&
      (github.event_name != 'workflow_dispatch' || !inputs.skip_push)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ansible-builder
        run: |
          python -m pip install --upgrade pip
          pip install ansible-builder ansible-navigator

      - name: Log in to registry.redhat.io (optional)
        continue-on-error: true
        env:
          REDHAT_REGISTRY_USER: ${{ secrets.REDHAT_REGISTRY_USER }}
          REDHAT_REGISTRY_PASSWORD: ${{ secrets.REDHAT_REGISTRY_PASSWORD }}
        run: |
          if [[ -n "$REDHAT_REGISTRY_USER" ]] && [[ -n "$REDHAT_REGISTRY_PASSWORD" ]]; then
            echo "Logging in to registry.redhat.io..."
            echo "$REDHAT_REGISTRY_PASSWORD" | podman login registry.redhat.io \
              --username "$REDHAT_REGISTRY_USER" --password-stdin
          else
            echo "Skipping registry.redhat.io login (credentials not provided)"
          fi

      - name: Generate ansible.cfg from template
        env:
          ANSIBLE_HUB_TOKEN: ${{ secrets.ANSIBLE_HUB_TOKEN }}
        run: |
          if [[ ! -f ansible.cfg ]]; then
            echo "Generating ansible.cfg from template..."
            envsubst < files/ansible.cfg.template > ansible.cfg
            echo "✅ ansible.cfg generated"
          fi

          # Verify ansible.cfg was created and token was substituted
          echo "Verifying ansible.cfg..."
          if grep -q '\$ANSIBLE_HUB_TOKEN' ansible.cfg; then
            echo "❌ ERROR: Token placeholder not substituted in ansible.cfg"
            exit 1
          fi
          if grep -q 'token=' ansible.cfg; then
            echo "✅ Token field found in ansible.cfg"
          else
            echo "❌ ERROR: No token field in ansible.cfg"
            exit 1
          fi

      - name: Rebuild execution environment for publish
        env:
          ANSIBLE_HUB_TOKEN: ${{ secrets.ANSIBLE_HUB_TOKEN }}
        run: |
          echo "Rebuilding execution environment for publish..."
          if [[ ! -f "execution-environment.yml" ]]; then
            echo "Error: execution-environment.yml not found"
            exit 1
          fi

          TAG="${{ needs.build-test.outputs.image_tag }}"
          echo "Building image: openshift-aiops-platform-ee:${TAG}"

          ansible-builder build \
            --tag openshift-aiops-platform-ee:${TAG} \
            --verbosity ${{ inputs.verbosity || 3 }} \
            --container-runtime ${{ env.CONTAINER_ENGINE }}

          echo "✅ Execution environment built successfully"
          echo "Image: openshift-aiops-platform-ee:${TAG}"

      - name: Log in to Quay.io
        env:
          QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
          QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}
        run: |
          echo "$QUAY_PASSWORD" | podman login ${{ env.TARGET_HUB }} \
            --username "$QUAY_USERNAME" --password-stdin

      - name: Tag and push to Quay.io
        run: |
          TAG="${{ needs.build-test.outputs.image_tag }}"

          # Tag with specific version
          echo "Tagging image for Quay.io..."
          podman tag openshift-aiops-platform-ee:${TAG} \
            ${{ env.TARGET_HUB }}/${{ env.TARGET_NAME }}:${TAG}

          echo "Pushing ${{ env.TARGET_HUB }}/${{ env.TARGET_NAME }}:${TAG}"
          podman push ${{ env.TARGET_HUB }}/${{ env.TARGET_NAME }}:${TAG}

          # Also push 'latest' tag for main branch and git tags
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/tags/"* ]]; then
            echo "Tagging and pushing 'latest'..."
            podman tag openshift-aiops-platform-ee:${TAG} \
              ${{ env.TARGET_HUB }}/${{ env.TARGET_NAME }}:latest
            podman push ${{ env.TARGET_HUB }}/${{ env.TARGET_NAME }}:latest
          fi

      - name: Generate manifest summary
        run: |
          TAG="${{ needs.build-test.outputs.image_tag }}"
          echo "## Image Manifest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${{ env.TARGET_HUB }}/${{ env.TARGET_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get image details
          podman inspect ${{ env.TARGET_HUB }}/${{ env.TARGET_NAME }}:${TAG} \
            --format '**Size:** {{.Size}} bytes
          **Created:** {{.Created}}
          **Layers:** {{len .RootFS.Layers}}' >> $GITHUB_STEP_SUMMARY || true

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "podman pull ${{ env.TARGET_HUB }}/${{ env.TARGET_NAME }}:${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [build-test, publish]
    if: always()

    steps:
      - name: Generate workflow summary
        run: |
          echo "# Build and Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build results
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.build-test.result }}" == "success" ]]; then
            echo "✅ **Build:** Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Build:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Test results
          echo "✅ **Test:** Passed" >> $GITHUB_STEP_SUMMARY

          # Publish results
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Publish Results" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.publish.result }}" == "success" ]]; then
            echo "✅ **Published to Quay.io:** \`${{ env.TARGET_HUB }}/${{ env.TARGET_NAME }}:${{ needs.build-test.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**View on Quay.io:** https://quay.io/repository/${{ env.TARGET_NAME }}" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.publish.result }}" == "skipped" ]]; then
            echo "⏭️ **Publish:** Skipped (branch: ${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Publish:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${{ needs.build-test.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch/Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
