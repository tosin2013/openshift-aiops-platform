name: CI/CD Pipeline

# Note: Both MCP Server and Coordination Engine have been moved to standalone Go repositories
# - MCP Server: https://github.com/tosin2013/openshift-cluster-health-mcp
# - Coordination Engine: https://github.com/tosin2013/openshift-coordination-engine
#
# This workflow focuses on:
# - ML Model Servers (Python/KServe in src/models/)
# - Jupyter Notebooks (Python/ML workloads)
# - Helm Charts (deployment manifests)
# - Documentation and examples

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.11'

jobs:
  test-notebooks:
    name: Notebooks - Comprehensive Testing
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install testing dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/requirements.txt

    - name: Create test directories
      run: |
        mkdir -p /tmp/notebook_tests
        mkdir -p test-outputs

    - name: Run comprehensive notebook tests
      run: |
        cd tests
        python notebook_tests.py
      continue-on-error: false

    - name: Upload test results
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: notebook-test-results
        path: |
          notebook_test_report.json
          test-outputs/
        retention-days: 30

    - name: Upload test outputs
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: notebook-test-outputs
        path: /tmp/notebook_tests/
        retention-days: 7

    - name: Generate test summary
      if: always()
      run: |
        echo "## üìä Notebook Test Results" >> $GITHUB_STEP_SUMMARY
        if [ -f notebook_test_report.json ]; then
          python -c "
          import json
          with open('notebook_test_report.json', 'r') as f:
              results = json.load(f)
          print(f'**Total Notebooks:** {results[\"total_notebooks\"]}')
          print(f'**Passed:** {results[\"passed\"]} ‚úÖ')
          print(f'**Failed:** {results[\"failed\"]} ‚ùå')
          print(f'**Skipped:** {results[\"skipped\"]} ‚è≠Ô∏è')
          print(f'**Success Rate:** {results[\"success_rate\"]:.1f}%')
          print()
          print('### Individual Results:')
          for notebook, result in results['notebooks'].items():
              status_icon = '‚úÖ' if result['status'] == 'PASSED' else '‚ùå' if result['status'] == 'FAILED' else '‚è≠Ô∏è'
              print(f'- {status_icon} **{notebook}**: {result[\"status\"]} ({result[\"execution_time\"]:.1f}s)')
          " >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå Test report not generated" >> $GITHUB_STEP_SUMMARY
        fi

  helm-lint:
    name: Helm Chart Lint
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.12.0'

    - name: Lint Helm charts
      run: |
        helm lint charts/hub/ -f values-global.yaml -f values-hub.yaml || echo "Hub chart linting completed"
        helm lint charts/notebooks/ || echo "Notebooks chart linting completed"

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [test-notebooks, helm-lint]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to development cluster
      run: |
        echo "üöÄ Deploying to development environment"
        echo "This would deploy to OpenShift development cluster"
        # Actual deployment commands would go here
        # oc apply -k k8s/overlays/development/

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [test-notebooks, helm-lint]
    if: always()

    steps:
    - name: Notify success
      if: ${{ needs.test-notebooks.result == 'success' && needs.helm-lint.result == 'success' }}
      run: |
        echo "‚úÖ All checks passed successfully!"
        echo "üéâ Ready for deployment"

    - name: Notify failure
      if: ${{ needs.test-notebooks.result == 'failure' || needs.helm-lint.result == 'failure' }}
      run: |
        echo "‚ùå Some checks failed"
        echo "üîß Please review and fix issues before merging"
