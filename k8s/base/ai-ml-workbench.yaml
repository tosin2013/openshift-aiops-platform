apiVersion: kubeflow.org/v1
kind: Notebook
metadata:
  name: self-healing-workbench
  labels:
    app.kubernetes.io/component: ai-ml-workbench
    app: self-healing-workbench
  annotations:
    notebooks.opendatahub.io/inject-oauth: "true"
    notebooks.opendatahub.io/oauth-logout-url: "https://rhods-dashboard-redhat-ods-applications.apps.cluster.example.com/projects/self-healing-platform"
spec:
  template:
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: nvidia.com/gpu.present
                    operator: In
                    values: ["true"]
      containers:
        - name: self-healing-workbench
          image: >-
            quay.io/opendatahub/workbench-images:jupyter-datascience-c9s-py311_2023c_latest
          resources:
            requests:
              cpu: "1"
              memory: "4Gi"
            limits:
              cpu: "4"
              memory: "16Gi"
              nvidia.com/gpu: "1"
          env:
            - name: JUPYTER_ENABLE_LAB
              value: "yes"
            - name: JUPYTER_PRELOAD_REPOS
              value: >-
                https://gitea-with-admin-gitea.apps.cluster-fn2qb.fn2qb.sandbox1343.opentlc.com
                /opentlc-mgr/openshift-aiops-platform.git
            - name: GITEA_ENABLED
              value: "true"
            - name: GITEA_URL
              value: "gitea-with-admin-gitea.apps.cluster-fn2qb.fn2qb.sandbox1343.opentlc.com"
            - name: PIP_TRUSTED_HOST
              value: "pypi.org pypi.python.org files.pythonhosted.org"
            - name: PROMETHEUS_URL
              value: "https://prometheus-k8s.openshift-monitoring.svc.cluster.local:9091"
            - name: S3_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: model-storage-config
                  key: AWS_S3_ENDPOINT
            - name: S3_BUCKET
              valueFrom:
                secretKeyRef:
                  name: model-storage-config
                  key: AWS_S3_BUCKET
          volumeMounts:
            - name: data-volume
              mountPath: /opt/app-root/src/data
            - name: model-artifacts
              mountPath: /opt/app-root/src/models
            - name: notebook-config
              mountPath: /opt/app-root/src/.jupyter/config
          workingDir: /opt/app-root/src
      volumes:
        - name: data-volume
          persistentVolumeClaim:
            claimName: self-healing-data
        - name: model-artifacts
          persistentVolumeClaim:
            claimName: model-artifacts
        - name: notebook-config
          configMap:
            name: jupyter-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: jupyter-config
  labels:
    app.kubernetes.io/component: ai-ml-workbench
data:
  jupyter_server_config.py: |
    # Jupyter server configuration for Self-Healing Platform
    import os

    # Basic server configuration
    c.ServerApp.ip = '0.0.0.0'
    c.ServerApp.port = 8888
    c.ServerApp.open_browser = False
    c.ServerApp.allow_root = True
    c.ServerApp.token = ''
    c.ServerApp.password = ''
    c.ServerApp.disable_check_xsrf = True

    # Handle base URL from NB_PREFIX environment variable
    nb_prefix = os.environ.get('NB_PREFIX', '')
    if nb_prefix:
        c.ServerApp.base_url = nb_prefix
        c.ServerApp.default_url = f'{nb_prefix}/lab'
    else:
        c.ServerApp.default_url = '/lab'

    # Enable JupyterLab by default
    c.LabApp.default_url = '/lab'

    # Set default kernel
    c.MultiKernelManager.default_kernel_name = 'python3'

    # Trust notebooks by default
    c.ServerApp.trust_xheaders = True

    # Configure writable directories
    c.ServerApp.runtime_dir = '/opt/app-root/src/.local/share/jupyter/runtime'
    c.LabApp.workspaces_dir = '/opt/app-root/src/.local/share/jupyter/lab/workspaces'
    c.LabApp.user_settings_dir = '/opt/app-root/src/.local/share/jupyter/lab/user-settings'

  requirements.txt: |
    # Self-Healing Platform Specific Libraries
    # Note: PyTorch base image already includes: torch, numpy, pandas, scikit-learn, matplotlib

    # Time Series Analysis for Anomaly Detection
    statsmodels>=0.14.0
    prophet>=1.1.4
    tslearn>=0.6.0

    # Advanced Anomaly Detection
    pyod>=1.1.0
    isolation-forest>=0.1.0

    # Additional ML Libraries (not in PyTorch base)
    xgboost>=2.0.0
    lightgbm>=4.0.0

    # Monitoring and Platform Integration
    prometheus-client>=0.17.0
    kubernetes>=28.0.0

    # Model Serving Integration
    kserve>=0.11.0

    # Enhanced Visualization
    seaborn>=0.12.0
    plotly>=5.17.0
    bokeh>=3.0.0

    # Self-Healing Specific Tools
    networkx>=3.0  # For dependency graph analysis
    pyyaml>=6.0    # For configuration management
    requests>=2.31.0  # For API integration

    # Jupyter Extensions and Tools
    jupyter-prometheus-exporter>=0.2.0
    ipywidgets>=8.0.0
    jupyterlab-git>=0.44.0
